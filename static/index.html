<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vision Agent</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    .msg-enter { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .pulse-dot { animation: pulse-dot 1.5s ease-in-out infinite; }
  </style>
</head>
<body class="h-full bg-slate-900 text-gray-100 flex flex-col">

  <!-- Header -->
  <header class="flex items-center justify-between px-6 py-3 bg-slate-800 border-b border-slate-700 shrink-0">
    <div class="flex items-center gap-3">
      <h1 class="text-xl font-bold text-cyan-400">Vision Agent</h1>
      <span id="status-dot" class="w-2.5 h-2.5 rounded-full bg-green-500 pulse-dot" title="Connected"></span>
    </div>
    <span class="text-xs text-slate-500">Webcam &bull; Nano Banana &bull; Veo3 &bull; ASL</span>
  </header>

  <!-- Main layout -->
  <div class="flex flex-1 overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-72 bg-slate-800 border-r border-slate-700 flex flex-col p-4 gap-5 overflow-y-auto shrink-0">

      <!-- Camera Controls -->
      <section>
        <h2 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">Camera Controls</h2>
        <button onclick="sendMessage('List my cameras')"
                class="w-full mb-2 px-3 py-2 bg-cyan-600 hover:bg-cyan-500 text-white text-sm font-medium rounded-lg transition">
          Detect Cameras
        </button>
        <div class="flex gap-2">
          <select id="camera-select" class="flex-1 bg-slate-700 text-sm text-gray-200 rounded-lg px-2 py-2 border border-slate-600 focus:outline-none focus:border-cyan-500">
            <option value="">No cameras detected</option>
          </select>
          <button onclick="openSelectedCamera()"
                  class="px-3 py-2 bg-slate-600 hover:bg-slate-500 text-white text-sm font-medium rounded-lg transition">
            Open
          </button>
        </div>
      </section>

      <!-- Capture / Upload -->
      <section>
        <h2 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">Capture / Upload</h2>
        <div class="flex gap-2">
          <button onclick="sendMessage('Take a photo')"
                  class="flex-1 px-3 py-2 bg-cyan-600 hover:bg-cyan-500 text-white text-sm font-medium rounded-lg transition">
            Take a Photo
          </button>
          <button onclick="document.getElementById('file-upload').click()"
                  class="flex-1 px-3 py-2 bg-slate-600 hover:bg-slate-500 text-white text-sm font-medium rounded-lg transition">
            Upload Image
          </button>
          <input id="file-upload" type="file" accept="image/*" class="hidden" onchange="handleUpload(event)">
        </div>
      </section>

      <!-- Nano Banana -->
      <section>
        <h2 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">Nano Banana</h2>
        <div class="flex gap-2">
          <select id="banana-select" class="flex-1 bg-slate-700 text-sm text-gray-200 rounded-lg px-2 py-2 border border-slate-600 focus:outline-none focus:border-cyan-500">
            <option value="Transform my latest photo into cyberpunk digital art">Cyberpunk digital art</option>
            <option value="Transform my latest photo into a watercolor painting">Watercolor painting</option>
            <option value="Transform my latest photo into an oil painting in the style of Van Gogh">Van Gogh oil painting</option>
            <option value="Transform my latest photo into a Pixar-style 3D cartoon">Pixar 3D cartoon</option>
            <option value="Transform my latest photo into anime style">Anime style</option>
            <option value="Transform my latest photo into a comic book illustration">Comic book illustration</option>
            <option value="Transform my latest photo into a pencil sketch drawing">Pencil sketch</option>
            <option value="Transform my latest photo into a neon synthwave poster">Neon synthwave poster</option>
            <option value="Transform my latest photo into a Renaissance painting">Renaissance painting</option>
            <option value="Transform my latest photo into a pop art print like Andy Warhol">Pop art (Warhol)</option>
            <option value="Transform my latest photo into a Studio Ghibli scene">Studio Ghibli scene</option>
            <option value="Transform my latest photo into a vintage 1950s travel poster">Vintage travel poster</option>
            <option value="Transform my latest photo into a stained glass window design">Stained glass</option>
            <option value="Transform my latest photo into a low-poly geometric art piece">Low-poly geometric</option>
            <option value="Transform my latest photo into a surrealist painting like Salvador Dali">Surrealist (Dali)</option>
            <option value="Transform my latest photo into a pixel art retro game sprite">Pixel art retro</option>
            <option value="Transform my latest photo into a traditional Japanese woodblock print">Japanese woodblock</option>
            <option value="Transform my latest photo into a dark gothic fantasy illustration">Gothic fantasy</option>
            <option value="Transform my latest photo into a minimalist line art drawing">Minimalist line art</option>
            <option value="Transform my latest photo into a photorealistic cinematic movie still">Cinematic movie still</option>
          </select>
          <button onclick="sendMessage(document.getElementById('banana-select').value)"
                  class="px-3 py-2 bg-amber-600 hover:bg-amber-500 text-white text-sm font-medium rounded-lg transition whitespace-nowrap">
            Generate
          </button>
        </div>
      </section>

      <!-- Veo3 Video -->
      <section>
        <h2 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">Veo3 Video</h2>
        <div class="flex gap-2">
          <select id="veo-select" class="flex-1 bg-slate-700 text-sm text-gray-200 rounded-lg px-2 py-2 border border-slate-600 focus:outline-none focus:border-cyan-500">
            <option value="Create a short video from my latest image with gentle camera movement">Gentle camera pan</option>
            <option value="Create a short video from my latest image with a dramatic zoom in">Dramatic zoom in</option>
            <option value="Create a short video from my latest image with a slow cinematic dolly shot">Cinematic dolly shot</option>
            <option value="Create a short video from my latest image coming to life with subtle motion">Subtle motion</option>
            <option value="Create a short video from my latest image with falling rain and moody lighting">Rain and moody lighting</option>
            <option value="Create a short video from my latest image with particles and magical sparkles floating around">Magical sparkles</option>
            <option value="Create a short video from my latest image with ocean waves crashing in the background">Ocean waves</option>
            <option value="Create a short video from my latest image with a timelapse sunrise effect">Timelapse sunrise</option>
            <option value="Create a short video from my latest image with snow falling gently">Falling snow</option>
            <option value="Create a short video from my latest image with fire and embers rising">Fire and embers</option>
            <option value="Create a short video from my latest image as if it were a scene in a music video">Music video style</option>
            <option value="Create a short video from my latest image with a dreamy soft focus and lens flares">Dreamy lens flares</option>
            <option value="Create a short video from my latest image with an epic drone flyover perspective">Drone flyover</option>
            <option value="Create a short video from my latest image in the style of a vintage film reel">Vintage film reel</option>
            <option value="Create a short video from my latest image with glitch art and VHS distortion effects">Glitch art / VHS</option>
          </select>
          <button onclick="sendMessage(document.getElementById('veo-select').value)"
                  class="px-3 py-2 bg-purple-600 hover:bg-purple-500 text-white text-sm font-medium rounded-lg transition whitespace-nowrap">
            Generate
          </button>
        </div>
      </section>

      <!-- ASL -->
      <section>
        <h2 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">ASL Interpreter</h2>
        <div class="flex gap-2">
          <select id="asl-select" class="flex-1 bg-slate-700 text-sm text-gray-200 rounded-lg px-2 py-2 border border-slate-600 focus:outline-none focus:border-cyan-500">
            <option value="30">30 seconds</option>
            <option value="90">90 seconds</option>
            <option value="120">120 seconds</option>
          </select>
          <button onclick="sendAsl()"
                  class="px-3 py-2 bg-green-600 hover:bg-green-500 text-white text-sm font-medium rounded-lg transition whitespace-nowrap">
            Record
          </button>
        </div>
      </section>

      <!-- Stop Camera -->
      <section>
        <button onclick="sendMessage('Stop the camera')"
                class="w-full px-3 py-2 bg-slate-700 hover:bg-red-900/40 text-sm font-medium rounded-lg transition text-red-400 border border-slate-600">
          Stop Camera
        </button>
      </section>
    </aside>

    <!-- Chat Area -->
    <main class="flex-1 flex flex-col">

      <!-- Messages -->
      <div id="messages" class="flex-1 overflow-y-auto p-6 space-y-4">
        <div id="welcome" class="max-w-xl mx-auto py-6 space-y-4">
          <h2 class="text-lg font-bold text-cyan-400 text-center">Welcome to Vision Agent</h2>
          <p class="text-sm text-slate-400 text-center">AI-powered webcam capture, image transformation, video generation, and ASL interpretation.</p>
          <div class="grid grid-cols-2 gap-3 text-xs text-slate-300">
            <div class="bg-slate-800 rounded-lg p-3 border border-slate-700">
              <div class="font-semibold text-cyan-400 mb-1">1. Setup Camera</div>
              Click <strong>Detect Cameras</strong> in the sidebar, select your camera, and click <strong>Open</strong>.
            </div>
            <div class="bg-slate-800 rounded-lg p-3 border border-slate-700">
              <div class="font-semibold text-amber-400 mb-1">2. Capture &amp; Transform</div>
              Click <strong>Take a Photo</strong>, then pick a style from the <strong>Nano Banana</strong> dropdown and hit <strong>Generate</strong>.
            </div>
            <div class="bg-slate-800 rounded-lg p-3 border border-slate-700">
              <div class="font-semibold text-purple-400 mb-1">3. Animate</div>
              Choose an effect from <strong>Veo3 Video</strong> and click <strong>Generate</strong> to create a short AI video clip.
            </div>
            <div class="bg-slate-800 rounded-lg p-3 border border-slate-700">
              <div class="font-semibold text-green-400 mb-1">4. ASL Conversation</div>
              Sign in ASL via your webcam -- select a duration, click <strong>Record</strong>, and the agent reads your signing and replies in natural language.
            </div>
          </div>
          <div class="bg-slate-800 rounded-lg p-3 border border-slate-700 text-xs text-slate-400">
            <div class="font-semibold text-slate-300 mb-1">Or just type naturally</div>
            The agent understands free-form prompts. Try things like:<br>
            <span class="text-slate-300">"Take a photo and turn it into a Van Gogh painting"</span><br>
            <span class="text-slate-300">"Make a cinematic video from my latest image"</span><br>
            <span class="text-slate-300">"Open camera 1 with avfoundation backend"</span>
          </div>
          <p class="text-xs text-slate-500 text-center">All outputs are saved to the <code class="bg-slate-700 px-1 rounded">outputs/</code> folder and displayed inline below.</p>
        </div>
      </div>

      <!-- Tool indicator -->
      <div id="tool-indicator" class="hidden px-6 pb-2">
        <span class="inline-flex items-center gap-2 px-3 py-1.5 bg-amber-900/40 text-amber-300 text-xs font-medium rounded-full border border-amber-700/50">
          <svg class="w-3 h-3 animate-spin" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31 31"/></svg>
          <span id="tool-name">Calling tool...</span>
        </span>
      </div>

      <!-- Input -->
      <form onsubmit="handleSubmit(event)" class="p-4 border-t border-slate-700 flex gap-3 shrink-0">
        <input id="input" type="text" placeholder="Type a message..."
               class="flex-1 bg-slate-800 text-gray-100 text-sm rounded-lg px-4 py-3 border border-slate-600 focus:outline-none focus:border-cyan-500 placeholder-slate-500"
               autocomplete="off">
        <button type="submit" id="send-btn"
                class="px-5 py-3 bg-cyan-600 hover:bg-cyan-500 disabled:bg-slate-700 disabled:text-slate-500 text-white text-sm font-medium rounded-lg transition">
          Send
        </button>
      </form>
    </main>
  </div>

<script>
const APP_NAME = "kagent_vision";
const USER_ID = "web_user";
const API_BASE = "/api";

let sessionId = null;
let isProcessing = false;

// ── Session ─────────────────────────────────────────────
async function createSession() {
  try {
    const resp = await fetch(`${API_BASE}/apps/${APP_NAME}/users/${USER_ID}/sessions`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ state: {} }),
    });
    const data = await resp.json();
    sessionId = data.id;
    console.log("Session created:", sessionId);
  } catch (err) {
    console.error("Failed to create session:", err);
    appendMessage("system", "Failed to connect to agent. Is the server running?");
  }
}

// ── Sending messages ────────────────────────────────────
async function sendMessage(text) {
  if (!text.trim() || isProcessing) return;
  if (!sessionId) await createSession();
  if (!sessionId) return;

  isProcessing = true;
  updateSendButton();
  appendMessage("user", text);

  const payload = {
    app_name: APP_NAME,
    user_id: USER_ID,
    session_id: sessionId,
    new_message: {
      role: "user",
      parts: [{ text: text }],
    },
    streaming: true,
  };

  try {
    const resp = await fetch(`${API_BASE}/run_sse`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!resp.ok) {
      appendMessage("system", `Error: ${resp.status} ${resp.statusText}`);
      isProcessing = false;
      updateSendButton();
      return;
    }

    await handleSSEStream(resp);
  } catch (err) {
    console.error("SSE error:", err);
    appendMessage("system", "Connection error. Please try again.");
  }

  hideToolIndicator();
  isProcessing = false;
  updateSendButton();
}

// ── SSE stream parsing ──────────────────────────────────
async function handleSSEStream(resp) {
  const reader = resp.body.getReader();
  const decoder = new TextDecoder();
  let buffer = "";
  let agentText = "";
  let agentEl = null;
  let allText = "";

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;

    buffer += decoder.decode(value, { stream: true });
    const lines = buffer.split("\n");
    buffer = lines.pop(); // keep incomplete line

    for (const line of lines) {
      if (!line.startsWith("data: ")) continue;
      const jsonStr = line.slice(6).trim();
      if (!jsonStr) continue;

      let event;
      try { event = JSON.parse(jsonStr); } catch { continue; }

      console.log("SSE:", JSON.stringify(event).slice(0, 500));

      const content = event.content || {};
      const parts = content.parts || [];
      const role = content.role || "";

      for (const part of parts) {
        if (part.functionCall) {
          showToolIndicator(part.functionCall.name);
          agentText = "";
          agentEl = null;
        }
        if (part.functionResponse) {
          hideToolIndicator();
          agentText = "";
          agentEl = null;
        }
        if (part.text && role !== "user") {
          hideToolIndicator();
          const txt = part.text;

          // Deduplicate: skip if exact match or if text is already at the end
          if (txt === agentText) continue;
          if (agentText.endsWith(txt)) continue;

          // Cumulative update (text grows from what we have)
          if (txt.startsWith(agentText) && txt.length > agentText.length) {
            allText += txt.slice(agentText.length);
            agentText = txt;
          } else {
            // Genuine new delta
            agentText += txt;
            allText += txt;
          }

          if (!agentEl) {
            agentEl = appendMessage("agent", agentText);
          } else {
            agentEl.querySelector(".msg-body").innerHTML = renderMarkdown(agentText);
          }
          scrollToBottom();
        }
      }
    }
  }

  // Parse camera list from agent response for dropdown
  if (allText) {
    parseCameraList(allText);
  }
}

// ── UI helpers ──────────────────────────────────────────
function appendMessage(role, text) {
  const container = document.getElementById("messages");
  // Clear welcome screen on first message
  const welcome = document.getElementById("welcome");
  if (welcome) welcome.remove();

  const wrapper = document.createElement("div");
  wrapper.className = "msg-enter flex " + (role === "user" ? "justify-end" : "justify-start");

  const bubble = document.createElement("div");
  bubble.className = "max-w-[75%] rounded-2xl px-4 py-3 text-sm leading-relaxed ";

  if (role === "user") {
    bubble.className += "bg-cyan-700/50 text-cyan-50 rounded-br-md";
  } else if (role === "agent") {
    bubble.className += "bg-slate-700 text-gray-200 rounded-bl-md";
  } else {
    bubble.className += "bg-red-900/30 text-red-300 rounded-bl-md";
  }

  const body = document.createElement("div");
  body.className = "msg-body";
  body.innerHTML = renderMarkdown(text);
  bubble.appendChild(body);
  wrapper.appendChild(bubble);
  container.appendChild(wrapper);
  scrollToBottom();
  return wrapper;
}

function renderMarkdown(text) {
  // Basic markdown: bold, italic, code, links, line breaks
  let html = text
    .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
    .replace(/`([^`]+)`/g, '<code class="bg-slate-600 px-1 rounded text-xs">$1</code>')
    .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
    .replace(/\*(.+?)\*/g, "<em>$1</em>")
    .replace(/\n/g, "<br>");

  // Inline images: detect paths like outputs/something.jpg|png|webp
  html = html.replace(
    /(?:(?:\.\/)?outputs\/[\w._-]+\.(?:jpg|jpeg|png|webp|gif))/gi,
    (match) => {
      const src = "/" + match.replace(/^\.\//, "");
      return `<a href="${src}" target="_blank"><img src="${src}" class="rounded-lg mt-2 mb-1 max-w-full max-h-80 cursor-pointer border border-slate-600" loading="lazy"></a>`;
    }
  );

  // Inline videos: detect paths like outputs/something.mp4
  html = html.replace(
    /(?:(?:\.\/)?outputs\/[\w._-]+\.mp4)/gi,
    (match) => {
      const src = "/" + match.replace(/^\.\//, "");
      return `<video src="${src}" controls class="rounded-lg mt-2 mb-1 max-w-full max-h-80 border border-slate-600"></video>`;
    }
  );

  return html;
}

function scrollToBottom() {
  const el = document.getElementById("messages");
  el.scrollTop = el.scrollHeight;
}

function showToolIndicator(name) {
  document.getElementById("tool-indicator").classList.remove("hidden");
  document.getElementById("tool-name").textContent = `Calling ${name}...`;
}

function hideToolIndicator() {
  document.getElementById("tool-indicator").classList.add("hidden");
}

function updateSendButton() {
  const btn = document.getElementById("send-btn");
  const input = document.getElementById("input");
  btn.disabled = isProcessing;
  input.disabled = isProcessing;
}

function handleSubmit(e) {
  e.preventDefault();
  const input = document.getElementById("input");
  const text = input.value.trim();
  if (text) {
    sendMessage(text);
    input.value = "";
  }
}

// ── Camera dropdown ─────────────────────────────────────
function parseCameraList(text) {
  // Look for patterns like "Camera 0", "Index 0", "camera index 0", etc.
  const matches = [...text.matchAll(/(?:camera|index)\s*(\d+)/gi)];
  if (matches.length === 0) return;

  const select = document.getElementById("camera-select");
  select.innerHTML = "";
  const seen = new Set();
  for (const m of matches) {
    const idx = m[1];
    if (seen.has(idx)) continue;
    seen.add(idx);
    const opt = document.createElement("option");
    opt.value = idx;
    opt.textContent = `Camera ${idx}`;
    select.appendChild(opt);
  }
}

function openSelectedCamera() {
  const select = document.getElementById("camera-select");
  const idx = select.value;
  if (idx !== "") {
    sendMessage(`Open camera ${idx}`);
  }
}

async function handleUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  appendMessage("user", `Uploading ${file.name}...`);

  const formData = new FormData();
  formData.append("file", file);

  try {
    const resp = await fetch("/upload", { method: "POST", body: formData });
    const data = await resp.json();
    if (data.ok) {
      appendMessage("agent", `Image uploaded: ${data.path}\n${data.path}`);
      // Tell the agent about the uploaded file so it can use it
      sendMessage(`I uploaded an image file. It is saved at ${data.path}. Please use this image for any future transformations or video generation.`);
    } else {
      appendMessage("system", "Upload failed.");
    }
  } catch (err) {
    console.error("Upload error:", err);
    appendMessage("system", "Upload failed. Please try again.");
  }

  // Reset the file input so the same file can be re-uploaded
  event.target.value = "";
}

function sendAsl() {
  const secs = document.getElementById("asl-select").value;
  sendMessage(`Capture ${secs} seconds of frames and interpret my ASL signing`);
}

// ── Init ────────────────────────────────────────────────
createSession();
</script>

</body>
</html>
